<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Stockfish 17</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<script>
  function log(msg) {
    console.log(msg);
    if (window.Android) {
      try {
        window.Android.onEngineLine('info string [HTML] ' + msg);
      } catch(e) {}
    }
  }

  log('=== INIT SF17 ===');

  // Fake module для перехвата UMD
  window.module = { exports: {} };
  window.exports = window.module.exports;

  log('Loading WASM...');
  var xhr = new XMLHttpRequest();
  xhr.open('GET', 'stockfish.wasm', true);
  xhr.responseType = 'arraybuffer';

  xhr.onload = function() {
    if (xhr.status === 200 || xhr.status === 0) {
      log('WASM: ' + xhr.response.byteLength + ' bytes');
      window.wasmBinary = new Uint8Array(xhr.response);

      log('Loading stockfish.js...');
      var script = document.createElement('script');
      script.src = 'stockfish.js';

      script.onload = function() {
        log('stockfish.js loaded');

        // Перехватываем экспорт
        if (typeof module !== 'undefined' && module.exports && typeof module.exports === 'function') {
          window.Stockfish = module.exports;
          log('Stockfish found in module.exports');
        } else if (typeof Stockfish !== 'undefined') {
          log('Stockfish found globally');
        } else {
          log('ERROR: Stockfish not found');
          return;
        }

        log('typeof Stockfish: ' + typeof Stockfish);

        // Загружаем main.js
        var mainScript = document.createElement('script');
        mainScript.src = 'main.js';
        document.body.appendChild(mainScript);
      };

      script.onerror = function() {
        log('ERROR: Failed to load stockfish.js');
      };

      document.body.appendChild(script);
    } else {
      log('ERROR: WASM failed: ' + xhr.status);
    }
  };

  xhr.onerror = function() {
    log('ERROR: WASM network error');
  };

  xhr.send();
</script>
</body>
</html>